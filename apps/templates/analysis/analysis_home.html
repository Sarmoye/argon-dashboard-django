{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Source DataTables {% endblock title %}

{% block extrastyle %}
<style>
    /* Custom CSS for table styling */
    #dataTable {
        width: 100%; /* Set table width to 100% */
        border-collapse: collapse; /* Collapse table borders */
        border: 1px solid #ddd; /* Add border to table */
    }
    #dataTable th, #dataTable td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 8px; /* Add padding to table cells */
    }
    #dataTable th {
        background-color: #f2f2f2; /* Set background color for table header */
    }
    #dataTable tbody tr:nth-child(even) {
        background-color: #f2f2f2; /* Set background color for even rows */
        color: rgb(0, 0, 0);
    }
</style>
<style>
    .modal-lg {
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
        padding: 0.75rem 1.25rem;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .custom-select {
        border-radius: 0.25rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
    }
    
    .btn {
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .form-group label {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    </style>
{% endblock extrastyle %}

{% block extrahead %}
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <!-- DataTables CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <!-- DataTables Buttons CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extrahead %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Source Data</h1>
    <!-- Table responsive -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered mt-4" id="dataTable">
            <thead class="thead-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">System Name</th>
                    <th scope="col">Service Type</th>
                    <th scope="col">Service Name</th>
                    <th scope="col">Error Count</th>
                    <th scope="col">Error Reason</th>
                    <th scope="col">Timestamp</th>
                    <th scope="col">Error Form</th>
                </tr>
            </thead>
            <tbody>
                {% for data in fiche_erreurs %}
                <tr class="data-row">
                    <td>{{ data.id }}</td>
                    <td>{{ data.system_name }}</td>
                    <td>{{ data.service_type }}</td>
                    <td>{{ data.service_name }}</td>
                    <td>{{ data.error_count }}</td>
                    <td>{{ data.error_reason }}</td>
                    <td>{{ data.timestamp }}</td>
                    <!-- Button to trigger modal -->
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#errorFormModal{{ data.id }}">Open Form</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title font-weight-bold" id="errorFormModalLabel{{ data.id }}">
                    Error Form | System: {{ data.system_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form action="#" method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Pre-filled Information Section -->
                    <div class="card mb-4 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Basic Error Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="errorReason">
                                        Error Reason <i class="fas fa-info-circle text-primary" title="Describe the reason for the error. This field is pre-filled and cannot be edited."></i>
                                    </label>
                                    <textarea class="form-control bg-white" id="errorReason" name="error_reason" rows="3" required disabled>{{ data.error_reason }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="errorCount">Error Count</label>
                                    <input type="number" class="form-control bg-white" id="errorCount" name="error_count" value="{{ data.error_count }}" required disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="timestamp">Timestamp</label>
                                    <input type="text" class="form-control bg-white" id="timestamp" name="timestamp" value="{{ data.timestamp }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Resolution Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="resolutionDate">
                                        Resolution Date <i class="fas fa-info-circle" title="The date when the error was resolved."></i>
                                    </label>
                                    <input type="date" class="form-control" id="resolutionDate" name="resolution_date">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="teamResponsible">
                                        Team Responsible <i class="fas fa-info-circle" title="The team in charge of resolving the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="teamResponsible" name="team_responsible">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="frequence">Error Frequency</label>
                                    <select class="form-control custom-select" id="frequence" name="frequence">
                                        <option value="Isolated">Isolated</option>
                                        <option value="Recurring">Recurring</option>
                                        <option value="Frequent">Frequent</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="statutResolution">Resolution Status</label>
                                    <select class="form-control custom-select" id="statutResolution" name="statut_resolution">
                                        <option value="Not started">Not started</option>
                                        <option value="In progress">In progress</option>
                                        <option value="Resolved">Resolved</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="delaiResolution">
                                        Estimated Resolution Time <i class="fas fa-info-circle" title="The estimated time needed to resolve the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="delaiResolution" name="delai_resolution" value="{{ data.delai_resolution }}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="analysts">
                                        Analysts Involved <i class="fas fa-info-circle" title="List of analysts involved in resolving the error."></i>
                                    </label>
                                    <textarea class="form-control" id="analysts" name="analysts" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="delaiEcoule">
                                        Elapsed Time <i class="fas fa-info-circle" title="The time that has elapsed since the error was recorded."></i>
                                    </label>
                                    <input type="text" class="form-control" id="delaiEcoule" name="delai_ecoule" value="{{ data.delai_ecoule }}">
                                </div>
                                <div class="col-md-6 mb-3 d-flex align-items-center">
                                    <div class="custom-control custom-checkbox mt-4">
                                        <input type="checkbox" class="custom-control-input" id="analystErrorNormal" name="erreur_normale">
                                        <label class="custom-control-label font-weight-bold" for="analystErrorNormal">Normal Error (No Impact)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impact Analysis Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Impact Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impactUtilisateur">
                                        Impact on Users <i class="fas fa-info-circle" title="Describe the impact of the error on end users."></i>
                                    </label>
                                    <input type="text" class="form-control" id="impactUtilisateur" name="impact_utilisateur">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impactFinancier">
                                        Financial Impact <i class="fas fa-info-circle" title="The financial cost associated with the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="impactFinancier" name="impact_financier" value="{{ data.impact_financier }}">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="nombreUtilisateurs">
                                        Number of Users Affected <i class="fas fa-info-circle" title="The total number of users impacted by the error."></i>
                                    </label>
                                    <input type="number" class="form-control" id="nombreUtilisateurs" name="nombre_utilisateurs_impactes" value="{{ data.nombre_utilisateurs_impactes }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="zoneGeographique">
                                        Geographical Zone Affected <i class="fas fa-info-circle" title="The geographical area affected by the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="zoneGeographique" name="zone_geographique_affectee" value="{{ data.zone_geographique_affectee }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Technical Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="typeErreur">
                                        Error Type <i class="fas fa-info-circle" title="The type or category of the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="typeErreur" name="type_erreur">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="categorieErreur">
                                        Error Category <i class="fas fa-info-circle" title="The category or classification of the error."></i>
                                    </label>
                                    <input type="text" class="form-control" id="categorieErreur" name="categorie_erreur" value="{{ data.categorie_erreur }}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="versionSysteme">
                                        System Version <i class="fas fa-info-circle" title="The version of the system where the error occurred."></i>
                                    </label>
                                    <input type="text" class="form-control" id="versionSysteme" name="version_systeme" value="{{ data.version_systeme }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="niveauCriticite">
                                        Criticality Level <i class="fas fa-info-circle" title="The severity or criticality level of the error."></i>
                                    </label>
                                    <input type="number" class="form-control" id="niveauCriticite" name="niveau_criticite" value="{{ data.niveau_criticite }}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="comportementAttendu">
                                        Expected Behavior <i class="fas fa-info-circle" title="Describe the expected behavior of the system."></i>
                                    </label>
                                    <textarea class="form-control" id="comportementAttendu" name="comportement_attendu" rows="3">{{ data.comportement_attendu }}</textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="comportementObserve">
                                        Observed Behavior <i class="fas fa-info-circle" title="Describe the behavior observed during the error."></i>
                                    </label>
                                    <textarea class="form-control" id="comportementObserve" name="comportement_observe" rows="3">{{ data.comportement_observe }}</textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="historiqueActions">
                                        Action History <i class="fas fa-info-circle" title="Details of actions taken to resolve the error."></i>
                                    </label>
                                    <textarea class="form-control" id="historiqueActions" name="historique_actions" rows="3">{{ data.historique_actions }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endfor %}
<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorFormModalLabel{{ data.id }}">Error Form | System : {{ data.system_name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="#" method="POST">
                    {% csrf_token %}
                
                    <!-- Pre-filled Fields -->
                    <div class="form-group">
                        <label for="errorReason">Error Reason <span title="Describe the reason for the error. This field is pre-filled and cannot be edited.">ℹ️</span></label>
                        <textarea class="form-control" id="errorReason" name="error_reason" rows="3" required disabled>{{ data.error_reason }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="errorCount">Error Count <span title="The number of occurrences for this error. This field is pre-filled and cannot be edited.">ℹ️</span></label>
                        <input type="number" class="form-control" id="errorCount" name="error_count" value="{{ data.error_count }}" required disabled>
                    </div>
                    <div class="form-group">
                        <label for="timestamp">Timestamp <span title="The date and time the error was recorded. This field is pre-filled and cannot be edited.">ℹ️</span></label>
                        <input type="text" class="form-control" id="timestamp" name="timestamp" value="{{ data.timestamp }}" disabled>
                    </div>
                
                    <!-- New Fields -->
                    <div class="form-group">
                        <label for="resolutionDate">Resolution Date <span title="The date when the error was resolved.">ℹ️</span></label>
                        <input type="date" class="form-control" id="resolutionDate" name="resolution_date">
                    </div>
                    <div class="form-group">
                        <label for="teamResponsible">Team Responsible <span title="The team in charge of resolving the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="teamResponsible" name="team_responsible">
                    </div>
                    <div class="form-group">
                        <label for="analystErrorNormal">Is this a normal error (no real impact)? <span title="Check this box if the error has no significant impact on the system.">ℹ️</span></label>
                        <input type="checkbox" id="analystErrorNormal" name="erreur_normale">
                    </div>
                    <div class="form-group">
                        <label for="frequence">Error Frequency <span title="The frequency of the error: isolated, recurring, or frequent.">ℹ️</span></label>
                        <select class="form-control" id="frequence" name="frequence">
                            <option value="Isolated">Isolated</option>
                            <option value="Recurring">Recurring</option>
                            <option value="Frequent">Frequent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statutResolution">Resolution Status <span title="The current resolution status of the error.">ℹ️</span></label>
                        <select class="form-control" id="statutResolution" name="statut_resolution">
                            <option value="Not started">Not started</option>
                            <option value="In progress">In progress</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="analysts">Analysts Involved <span title="List of analysts involved in resolving the error.">ℹ️</span></label>
                        <textarea class="form-control" id="analysts" name="analysts" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="impactUtilisateur">Impact on Users <span title="Describe the impact of the error on end users.">ℹ️</span></label>
                        <input type="text" class="form-control" id="impactUtilisateur" name="impact_utilisateur">
                    </div>
                    <div class="form-group">
                        <label for="typeErreur">Error Type <span title="The type or category of the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="typeErreur" name="type_erreur">
                    </div>
                    <div class="form-group">
                        <label for="historiqueActions">Action History <span title="Details of actions taken to resolve the error.">ℹ️</span></label>
                        <textarea class="form-control" id="historiqueActions" name="historique_actions" rows="3">{{ data.historique_actions }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="versionSysteme">System Version <span title="The version of the system where the error occurred.">ℹ️</span></label>
                        <input type="text" class="form-control" id="versionSysteme" name="version_systeme" value="{{ data.version_systeme }}">
                    </div>
                    <div class="form-group">
                        <label for="comportementAttendu">Expected Behavior <span title="Describe the expected behavior of the system.">ℹ️</span></label>
                        <textarea class="form-control" id="comportementAttendu" name="comportement_attendu" rows="3">{{ data.comportement_attendu }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="comportementObserve">Observed Behavior <span title="Describe the behavior observed during the error.">ℹ️</span></label>
                        <textarea class="form-control" id="comportementObserve" name="comportement_observe" rows="3">{{ data.comportement_observe }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="delaiResolution">Estimated Resolution Time <span title="The estimated time needed to resolve the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="delaiResolution" name="delai_resolution" value="{{ data.delai_resolution }}">
                    </div>
                    <div class="form-group">
                        <label for="delaiEcoule">Elapsed Time <span title="The time that has elapsed since the error was recorded.">ℹ️</span></label>
                        <input type="text" class="form-control" id="delaiEcoule" name="delai_ecoule" value="{{ data.delai_ecoule }}">
                    </div>
                    <div class="form-group">
                        <label for="impactFinancier">Financial Impact <span title="The financial cost associated with the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="impactFinancier" name="impact_financier" value="{{ data.impact_financier }}">
                    </div>
                    <div class="form-group">
                        <label for="nombreUtilisateurs">Number of Users Affected <span title="The total number of users impacted by the error.">ℹ️</span></label>
                        <input type="number" class="form-control" id="nombreUtilisateurs" name="nombre_utilisateurs_impactes" value="{{ data.nombre_utilisateurs_impactes }}">
                    </div>
                    <div class="form-group">
                        <label for="zoneGeographique">Geographical Zone Affected <span title="The geographical area affected by the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="zoneGeographique" name="zone_geographique_affectee" value="{{ data.zone_geographique_affectee }}">
                    </div>
                    <div class="form-group">
                        <label for="categorieErreur">Error Category <span title="The category or classification of the error.">ℹ️</span></label>
                        <input type="text" class="form-control" id="categorieErreur" name="categorie_erreur" value="{{ data.categorie_erreur }}">
                    </div>
                    <div class="form-group">
                        <label for="niveauCriticite">Criticality Level <span title="The severity or criticality level of the error.">ℹ️</span></label>
                        <input type="number" class="form-control" id="niveauCriticite" name="niveau_criticite" value="{{ data.niveau_criticite }}">
                    </div>
                
                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>          
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% include "includes/footer.html" %}
{% endblock content %}

{% block javascripts %}
<!-- Bootstrap JS (optional if not already included) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<!-- DataTables Buttons Print JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<!-- DataTables Buttons PDFMake JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<!-- DataTables Buttons VFS Fonts JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- DataTables Buttons CSV JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel'
                ]
            });
        });
    </script>
{% endblock javascripts %}