{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Source DataTables {% endblock title %}

{% block extrastyle %}
<style>
    /* Custom CSS for table styling */
    #dataTable {
        width: 100%; /* Set table width to 100% */
        border-collapse: collapse; /* Collapse table borders */
        border: 1px solid #ddd; /* Add border to table */
    }
    #dataTable th, #dataTable td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 8px; /* Add padding to table cells */
    }
    #dataTable th {
        background-color: #f2f2f2; /* Set background color for table header */
    }
    #dataTable tbody tr:nth-child(even) {
        background-color: #f2f2f2; /* Set background color for even rows */
        color: rgb(0, 0, 0);
    }
</style>
<style>
    .modal-lg {
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .custom-select {
        border-radius: 0.25rem;
    }
    
    .btn {
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
    }
    
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
    }
    </style>
{% endblock extrastyle %}

{% block extrahead %}
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <!-- DataTables CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <!-- DataTables Buttons CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extrahead %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Source Data</h1>
    <!-- Table responsive -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered mt-4" id="dataTable">
            <thead class="thead-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">System Name</th>
                    <th scope="col">Service Type</th>
                    <th scope="col">Service Name</th>
                    <th scope="col">Error Count</th>
                    <th scope="col">Error Reason</th>
                    <th scope="col">Timestamp</th>
                    <th scope="col">Error Form</th>
                </tr>
            </thead>
            <tbody>
                {% for data in fiche_erreurs %}
                <tr class="data-row">
                    <td>{{ data.id }}</td>
                    <td>{{ data.system_name }}</td>
                    <td>{{ data.service_type }}</td>
                    <td>{{ data.service_name }}</td>
                    <td>{{ data.error_count }}</td>
                    <td>{{ data.error_reason }}</td>
                    <td>{{ data.timestamp }}</td>
                    <!-- Button to trigger modal -->
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#errorFormModal{{ data.id }}">Open Form</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title font-weight-bold" id="errorFormModalLabel{{ data.id }}">
                    Error Form | System: {{ data.system_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form action="#" method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Pre-filled Information Section -->
                    <div class="card mb-4 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Error Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="errorReason">
                                        Error Reason <i class="fas fa-info-circle text-primary" title="Describe the reason for the error. This field is pre-filled and cannot be edited."></i>
                                    </label>
                                    <textarea class="form-control bg-white" id="errorReason" name="error_reason" rows="3" disabled>{{ data.error_reason }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="errorCount">Error Count</label>
                                    <input type="number" class="form-control bg-white" id="errorCount" value="{{ data.error_count }}" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="timestamp">Timestamp</label>
                                    <input type="text" class="form-control bg-white" id="timestamp" value="{{ data.timestamp }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Resolution Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="resolutionDate">Resolution Date</label>
                                    <input type="date" class="form-control" id="resolutionDate" name="resolution_date">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="teamResponsible">Team Responsible</label>
                                    <input type="text" class="form-control" id="teamResponsible" name="team_responsible">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="frequence">Error Frequency</label>
                                    <select class="form-control custom-select" id="frequence" name="frequence">
                                        <option value="Isolated">Isolated</option>
                                        <option value="Recurring">Recurring</option>
                                        <option value="Frequent">Frequent</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="statutResolution">Resolution Status</label>
                                    <select class="form-control custom-select" id="statutResolution" name="statut_resolution">
                                        <option value="Not started">Not started</option>
                                        <option value="In progress">In progress</option>
                                        <option value="Resolved">Resolved</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3 d-flex align-items-center">
                                    <div class="custom-control custom-checkbox mt-4">
                                        <input type="checkbox" class="custom-control-input" id="analystErrorNormal" name="erreur_normale">
                                        <label class="custom-control-label font-weight-bold" for="analystErrorNormal">Normal Error (No Impact)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impact Analysis Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Impact Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impactUtilisateur">Impact on Users</label>
                                    <input type="text" class="form-control" id="impactUtilisateur" name="impact_utilisateur">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="typeErreur">Error Type</label>
                                    <input type="text" class="form-control" id="typeErreur" name="type_erreur">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="historiqueActions">Action History</label>
                                    <textarea class="form-control" id="historiqueActions" name="historique_actions" rows="3">{{ data.historique_actions }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Technical Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="comportementAttendu">Expected Behavior</label>
                                    <textarea class="form-control" id="comportementAttendu" name="comportement_attendu" rows="3">{{ data.comportement_attendu }}</textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="comportementObserve">Observed Behavior</label>
                                    <textarea class="form-control" id="comportementObserve" name="comportement_observe" rows="3">{{ data.comportement_observe }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% include "includes/footer.html" %}
{% endblock content %}

{% block javascripts %}
<!-- Bootstrap JS (optional if not already included) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<!-- DataTables Buttons Print JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<!-- DataTables Buttons PDFMake JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<!-- DataTables Buttons VFS Fonts JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- DataTables Buttons CSV JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel'
                ]
            });
        });
    </script>
{% endblock javascripts %}