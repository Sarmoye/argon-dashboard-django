{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Source DataTables {% endblock title %}

{% block extrastyle %}
<style>
    /* Custom CSS for table styling */
    #dataTable {
        width: 100%; /* Set table width to 100% */
        border-collapse: collapse; /* Collapse table borders */
        border: 1px solid #ddd; /* Add border to table */
    }
    
    #dataTable th, #dataTable td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 8px; /* Add padding to table cells */
    }

    #dataTable th {
        background-color: #f2f2f2; /* Set background color for table header */
    }

    #dataTable tbody tr:nth-child(even) {
        background-color: #f2f2f2; /* Set background color for even rows */
        color: rgb(0, 0, 0);
    }

    .is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem) !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 80%;
        margin-top: 0.25rem;
    }

    .alert {
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    .spinner-border {
        margin-right: 0.5rem;
    }

    /* Improve checkbox styling */
    .custom-control-input:checked ~ .custom-control-label::before {
        border-color: #007bff;
        background-color: #007bff;
    }

    .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .modal-lg {
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
        padding: 0.75rem 1.25rem;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .custom-select {
        border-radius: 0.25rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
    }
    
    .btn {
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-body {
    scroll-behavior: smooth;
    }
    
    .form-group label {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    </style>
    <style>
        .form-section {
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background-color: #f3f4f6;
        }
    
        .section-header i.fa-chevron-down {
            transition: transform 0.3s ease;
        }
    
        .section-header.collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }
    
        .modal-xl {
            max-width: 1140px;
        }
    
        @media (max-width: 1200px) {
            .modal-xl {
                max-width: 90%;
            }
        }
    
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
    
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
    
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
{% endblock extrastyle %}

{% block extrahead %}
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <!-- DataTables CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <!-- DataTables Buttons CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extrahead %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Analysis Data</h1>
    <!-- Table responsive -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered mt-4" id="dataTable">
            <thead class="thead-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">System Name</th>
                    <th scope="col">Service Type</th>
                    <th scope="col">Service Name</th>
                    <th scope="col">Error Count</th>
                    <th scope="col">Error Reason</th>
                    <th scope="col">Source Timestamp</th>
                    <th scope="col">Error Form</th>
                </tr>
            </thead>
            <tbody>
                {% for data in fiche_erreurs %}
                <tr class="data-row">
                    <td>{{ data.id }}</td>
                    <td>{{ data.system_name }}</td>
                    <td>{{ data.service_type }}</td>
                    <td>{{ data.service_name }}</td>
                    <td>{{ data.error_count }}</td>
                    <td>{{ data.error_reason }}</td>
                    <td>{{ data.timestamp }}</td>
                    <!-- Button to trigger modal -->
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#errorFormModal{{ data.id }}">Open Form</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title font-weight-bold" id="errorFormModalLabel{{ data.id }}">
                    Error Form | System: {{ data.system_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="flex items-center space-x-3">
                    <span class="text-sm bg-blue-700 px-3 py-1 rounded-full" id="autoSaveStatus">
                        <i class="fas fa-save mr-1"></i> Auto-saving
                    </span>
                    <button type="button" class="close text-white hover:text-gray-200 transition" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Completion Status:</span>
                        <div class="w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="progress-bar-fill h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <span class="text-sm text-gray-600" id="progress-percentage">0%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition" id="collapseAll">
                            <i class="fas fa-compress-alt mr-1"></i> Collapse All
                        </button>
                        <button type="button" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition" id="expandAll">
                            <i class="fas fa-expand-alt mr-1"></i> Expand All
                        </button>
                    </div>
                </div>
                <form id="errorForm{{ data.id }}" action="{% url 'analysis:update_fiche_erreur' %}" method="POST">
                    {% csrf_token %}
                    <!-- Basic Information Section -->
                    <div class="form-section mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="section-header cursor-pointer p-3 bg-gray-50 border-b flex justify-between items-center" data-toggle="collapse" data-target="#basicInfo{{ data.id }}">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                <h6 class="font-semibold mb-0">Basic Information</h6>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div id="basicInfo{{ data.id }}" class="collapse show p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">System Name</label>
                                    <div class="relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-server text-gray-400"></i>
                                        </div>
                                        <input type="text" name="system_name" value="{{ data.system_name }}"
                                            class="form-input pl-10 block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                            required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                                    <div class="relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-cog text-gray-400"></i>
                                        </div>
                                        <input type="text" name="service_type" value="{{ data.service_type }}"
                                            class="form-input pl-10 block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                            required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Error Count</label>
                                    <div class="relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-hashtag text-gray-400"></i>
                                        </div>
                                        <input type="number" name="error_count" value="{{ data.error_count }}"
                                            class="form-input pl-10 block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Status and Priority Section -->
                    <div class="form-section mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="section-header cursor-pointer p-3 bg-gray-50 border-b flex justify-between items-center" data-toggle="collapse" data-target="#statusPriority{{ data.id }}">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>
                                <h6 class="font-semibold mb-0">Status & Priority</h6>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </div>
                        <div id="statusPriority{{ data.id }}" class="collapse show p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select name="statut" class="form-select block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Ouvert" {% if data.statut == "Ouvert" %}selected{% endif %}>
                                            🟢 Open
                                        </option>
                                        <option value="En cours" {% if data.statut == "En cours" %}selected{% endif %}>
                                            🟡 In Progress
                                        </option>
                                        <option value="Résolu" {% if data.statut == "Résolu" %}selected{% endif %}>
                                            🔵 Resolved
                                        </option>
                                        <option value="Fermé" {% if data.statut == "Fermé" %}selected{% endif %}>
                                            ⚫ Closed
                                        </option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select name="priorite" class="form-select block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Basse" {% if data.priorite == "Basse" %}selected{% endif %}>
                                            Low
                                        </option>
                                        <option value="Normale" {% if data.priorite == "Normale" %}selected{% endif %}>
                                            Normal
                                        </option>
                                        <option value="Élevée" {% if data.priorite == "Élevée" %}selected{% endif %}>
                                            High
                                        </option>
                                        <option value="Urgente" {% if data.priorite == "Urgente" %}selected{% endif %}>
                                            Urgent
                                        </option>
                                        <option value="Critique" {% if data.priorite == "Critique" %}selected{% endif %}>
                                            Critical
                                        </option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
                                    <select name="gravite" class="form-select block w-full rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Faible" {% if data.gravite == "Faible" %}selected{% endif %}>
                                            Low
                                        </option>
                                        <option value="Moyenne" {% if data.gravite == "Moyenne" %}selected{% endif %}>
                                            Medium
                                        </option>
                                        <option value="Elevée" {% if data.gravite == "Elevée" %}selected{% endif %}>
                                            High
                                        </option>
                                        <option value="Critique" {% if data.gravite == "Critique" %}selected{% endif %}>
                                            Critical
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Basic Information Section -->
                    <div class="card mb-4 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Basic Informations</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <label class="font-weight-bold" for="system_name">System Name</label>
                                    <input type="text" class="form-control" id="system_name" name="system_name" value="{{ data.system_name }}" required>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label class="font-weight-bold" for="service_type">Service Type</label>
                                    <input type="text" class="form-control" id="service_type" name="service_type" value="{{ data.service_type }}" required>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label class="font-weight-bold" for="service_name">Service Name</label>
                                    <input type="text" class="form-control" id="service_name" name="service_name" value="{{ data.service_name }}" required>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <label class="font-weight-bold" for="error_count">Error Count</label>
                                    <input type="number" class="form-control" id="error_count" name="error_count" value="{{ data.error_count }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="error_reason">Error Reason</label>
                                    <textarea class="form-control" id="error_reason" name="error_reason" rows="3" required>{{ data.error_reason }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Status and Priority Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Status and Priority</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="statut">Status</label>
                                    <select class="form-control" id="statut" name="statut">
                                        <option value="Ouvert" {% if data.statut == "Ouvert" %}selected{% endif %}>Open</option>
                                        <option value="En cours" {% if data.statut == "En cours" %}selected{% endif %}>In Progress</option>
                                        <option value="Résolu" {% if data.statut == "Résolu" %}selected{% endif %}>Resolved</option>
                                        <option value="Fermé" {% if data.statut == "Fermé" %}selected{% endif %}>Closed</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite">Priority</label>
                                    <select class="form-control" id="priorite" name="priorite">
                                        <option value="Basse" {% if data.priorite == "Basse" %}selected{% endif %}>Low</option>
                                        <option value="Normale" {% if data.priorite == "Normale" %}selected{% endif %}>Normal</option>
                                        <option value="Élevée" {% if data.priorite == "Élevée" %}selected{% endif %}>High</option>
                                        <option value="Urgente" {% if data.priorite == "Urgente" %}selected{% endif %}>Urgent</option>
                                        <option value="Critique" {% if data.priorite == "Critique" %}selected{% endif %}>Critical</option>
                                        <option value="Immédiate" {% if data.priorite == "Immédiate" %}selected{% endif %}>Immediate</option>
                                    </select>                                    
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite_numerique">Numerical Priority (1-5)</label>
                                    <input type="number" class="form-control" id="priorite_numerique" name="priorite_numerique" value="{{ data.priorite_numerique }}" min="1" max="5">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="niveau_criticite">Criticality Level (1-5)</label>
                                    <input type="number" class="form-control" id="niveau_criticite" name="niveau_criticite" value="{{ data.niveau_criticite }}" min="1" max="5">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="gravite">Severity</label>
                                    <select class="form-control" id="gravite" name="gravite">
                                        <option value="Faible" {% if data.gravite == "Faible" %}selected{% endif %}>Low</option>
                                        <option value="Moyenne" {% if data.gravite == "Moyenne" %}selected{% endif %}>Medium</option>
                                        <option value="Elevée" {% if data.gravite == "Elevée" %}selected{% endif %}>High</option>
                                        <option value="Critique" {% if data.gravite == "Critique" %}selected{% endif %}>Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Error Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Error Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="symptomes_observes">Observed Symptoms</label>
                                    <textarea class="form-control" id="symptomes_observes" name="symptomes_observes" rows="3">{{ data.symptomes_observes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="logs_messages">Log Messages</label>
                                    <textarea class="form-control" id="logs_messages" name="logs_messages" rows="3">{{ data.logs_messages }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="services_affectes">Affected Services</label>
                                    <textarea class="form-control" id="services_affectes" name="services_affectes" rows="2">{{ data.services_affectes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="cause">Root Cause</label>
                                    <textarea class="form-control" id="cause" name="cause" rows="2">{{ data.cause }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Resolution Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Resolution Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="statut_resolution">Resolution Status</label>
                                    <select class="form-control" id="statut_resolution" name="statut_resolution">
                                        <option value="Non commencé" {% if data.statut_resolution == "Non commencé" %}selected{% endif %}>Not Started</option>
                                        <option value="En cours" {% if data.statut_resolution == "En cours" %}selected{% endif %}>In Progress</option>
                                        <option value="Terminé" {% if data.statut_resolution == "Terminé" %}selected{% endif %}>Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_proposee">Proposed Solution</label>
                                    <textarea class="form-control" id="solution_proposee" name="solution_proposee" rows="3">{{ data.solution_proposee }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_implantee">Implemented Solution</label>
                                    <textarea class="form-control" id="solution_implantee" name="solution_implantee" rows="3">{{ data.solution_implantee }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="efficacite_solution">Solution Effectiveness (1-10)</label>
                                    <input type="number" class="form-control" id="efficacite_solution" name="efficacite_solution" value="{{ data.efficacite_solution }}" min="1" max="10">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="font-weight-bold" for="tests_effectues">Tests Performed</label>
                                    <textarea class="form-control" id="tests_effectues" name="tests_effectues" rows="2">{{ data.tests_effectues }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Technical Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Technical Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="code_erreur">Error Code</label>
                                    <input type="text" class="form-control" id="code_erreur" name="code_erreur" value="{{ data.code_erreur }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="version_systeme">System Version</label>
                                    <input type="text" class="form-control" id="version_systeme" name="version_systeme" value="{{ data.version_systeme }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="charge_systeme">System Load (%)</label>
                                    <input type="number" class="form-control" id="charge_systeme" name="charge_systeme" value="{{ data.charge_systeme }}" step="0.01" min="0" max="100">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="fichiers_impactes">Impacted Files/Modules</label>
                                    <textarea class="form-control" id="fichiers_impactes" name="fichiers_impactes" rows="2">{{ data.fichiers_impactes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Impact Assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Impact Assessment</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impact_financier">Financial Impact</label>
                                    <input type="number" class="form-control" id="impact_financier" name="impact_financier" value="{{ data.impact_financier }}" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="nombre_utilisateurs_impactes">Number of Users Affected</label>
                                    <input type="number" class="form-control" id="nombre_utilisateurs_impactes" name="nombre_utilisateurs_impactes" value="{{ data.nombre_utilisateurs_impactes }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="zone_geographique_affectee">Affected Geographical Area</label>
                                    <input type="text" class="form-control" id="zone_geographique_affectee" name="zone_geographique_affectee" value="{{ data.zone_geographique_affectee }}">
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Communication and Collaboration -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Communication and Collaboration</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="canaux_communication">Communication Channels</label>
                                    <input type="text" class="form-control" id="canaux_communication" name="canaux_communication" value="{{ data.canaux_communication }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox mt-4">
                                        <input type="checkbox" class="custom-control-input" id="notifications_envoyees" name="notifications_envoyees" {% if data.notifications_envoyees %}checked{% endif %}>
                                        <label class="custom-control-label" for="notifications_envoyees">Notifications Sent</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="parties_prenantes">Stakeholders</label>
                                    <textarea class="form-control" id="parties_prenantes" name="parties_prenantes" rows="2">{{ data.parties_prenantes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Additional Options -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Additional Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Parfois, le champ "analysts" est utilisé à la fois pour afficher la liste et pour activer une option.
                                     Ici, nous le considérons comme une simple zone d'affichage. -->
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <!-- Si vous souhaitez utiliser ce champ pour une option d'automatisation, il faut le dissocier de la liste des analystes -->
                                        <input type="checkbox" class="custom-control-input" id="automatisation_possible" name="automatisation_possible" {% if data.automatisation_possible %}checked{% endif %}>
                                        <label class="custom-control-label" for="automatisation_possible">Automatic Diagnosis/Correction Possible</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="resolution_automatique_possible" name="resolution_automatique_possible" {% if data.resolution_automatique_possible %}checked{% endif %}>
                                        <label class="custom-control-label" for="resolution_automatique_possible">Future Automation Possible</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Additional Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">Additional Details</h6>
                        </div>
                        <div class="card-body">
                            <!-- Timestamp, Status and Severity -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="timestamp">Timestamp</label>
                                    <!-- On utilise ici un input de type datetime-local. Assurez-vous de formater la valeur correctement -->
                                    <input type="datetime-local" class="form-control" id="timestamp" name="timestamp" value="{{ data.timestamp|date:'Y-m-d\\TH:i' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="frequence">Error Frequency</label>
                                    <select class="form-control" id="frequence" name="frequence">
                                        <option value="Rare" {% if data.frequence == "Rare" %}selected{% endif %}>Rare</option>
                                        <option value="Occasionnel" {% if data.frequence == "Occasionnel" %}selected{% endif %}>Occasional</option>
                                        <option value="Fréquente" {% if data.frequence == "Fréquente" %}selected{% endif %}>Frequent</option>
                                        <option value="Très fréquente" {% if data.frequence == "Très fréquente" %}selected{% endif %}>Very Frequent</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Hypotheses and Next Actions -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="hypotheses">Hypotheses</label>
                                    <textarea class="form-control" id="hypotheses" name="hypotheses" rows="3">{{ data.hypotheses }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="prochaines_actions">Next Actions</label>
                                    <textarea class="form-control" id="prochaines_actions" name="prochaines_actions" rows="3">{{ data.prochaines_actions }}</textarea>
                                </div>
                            </div>
                            <!-- Responsible Resolution and Comments -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="responsable_resolution">Responsible for Resolution</label>
                                    <input type="text" class="form-control" id="responsable_resolution" name="responsable_resolution" value="{{ data.responsable_resolution }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="commentaires">Comments</label>
                                    <textarea class="form-control" id="commentaires" name="commentaires" rows="3">{{ data.commentaires }}</textarea>
                                </div>
                            </div>
                            <!-- Error Type and User Impact -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="type_erreur">Error Type</label>
                                    <input type="text" class="form-control" id="type_erreur" name="type_erreur" value="{{ data.type_erreur }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impact_utilisateur">User Impact</label>
                                    <input type="text" class="form-control" id="impact_utilisateur" name="impact_utilisateur" value="{{ data.impact_utilisateur }}">
                                </div>
                            </div>
                            <!-- Resolution Status and Action History -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="statut_resolution">Resolution Status</label>
                                    <select class="form-control" id="statut_resolution" name="statut_resolution">
                                        <option value="Non commencé" {% if data.statut_resolution == "Non commencé" %}selected{% endif %}>Not Started</option>
                                        <option value="En cours" {% if data.statut_resolution == "En cours" %}selected{% endif %}>In Progress</option>
                                        <option value="Terminé" {% if data.statut_resolution == "Terminé" %}selected{% endif %}>Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="font-weight-bold" for="historique_actions">Action History</label>
                                    <textarea class="form-control" id="historique_actions" name="historique_actions" rows="3">{{ data.historique_actions }}</textarea>
                                </div>
                            </div>
                            <!-- Responsible Team and Frequency -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="equipe_responsable">Responsible Team</label>
                                    <input type="text" class="form-control" id="equipe_responsable" name="equipe_responsable" value="{{ data.equipe_responsable }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="frequence">Error Frequency</label>
                                    <input type="text" class="form-control" id="frequence" name="frequence" value="{{ data.frequence }}">
                                </div>
                            </div>
                            <!-- Expected and Observed Behavior -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="comportement_attendu">Expected Behavior</label>
                                    <textarea class="form-control" id="comportement_attendu" name="comportement_attendu" rows="3">{{ data.comportement_attendu }}</textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="comportement_observe">Observed Behavior</label>
                                    <textarea class="form-control" id="comportement_observe" name="comportement_observe" rows="3">{{ data.comportement_observe }}</textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <!-- Les champs de durée sont ici traités comme texte (format HH:MM:SS) -->
                                    <label class="font-weight-bold" for="delai_resolution">Estimated Resolution Time (HH:MM:SS)</label>
                                    <input type="text" class="form-control" id="delai_resolution" name="delai_resolution" value="{{ data.delai_resolution }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="delai_ecoule">Elapsed Time Since Detection (HH:MM:SS)</label>
                                    <input type="text" class="form-control" id="delai_ecoule" name="delai_ecoule" value="{{ data.delai_ecoule }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="categorie_erreur">Error Category</label>
                                    <input type="text" class="form-control" id="categorie_erreur" name="categorie_erreur" value="{{ data.categorie_erreur }}">
                                </div>
                            </div>
                            <!-- Detection Stage -->
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="etape_detection">Detection Stage</label>
                                    <input type="text" class="form-control" id="etape_detection" name="etape_detection" value="{{ data.etape_detection }}">
                                </div>
                            </div>
                            <!-- Similar Previous Incidents -->
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="precedent_incidents_similaires">Similar Previous Incidents</label>
                                    <textarea class="form-control" id="precedent_incidents_similaires" name="precedent_incidents_similaires" rows="3">{{ data.precedent_incidents_similaires }}</textarea>
                                </div>
                            </div>
                            <!-- Audit Log and Associated Documentation -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="audit_log">Audit Log</label>
                                    <textarea class="form-control" id="audit_log" name="audit_log" rows="3">{{ data.audit_log }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="documentation_associee">Associated Documentation</label>
                                    <textarea class="form-control" id="documentation_associee" name="documentation_associee" rows="3">{{ data.documentation_associee }}</textarea>
                                </div>
                            </div>
                            <!-- Normal Error Checkbox -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="erreur_normale" name="erreur_normale" {% if data.erreur_normale %}checked{% endif %}>
                                        <label class="custom-control-label" for="erreur_normale">Normal Error (No real impact)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Analysts Section (affichage seulement) -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">All Analysts</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="analysts">Analysts</label>
                                    <textarea class="form-control" id="analysts" name="analysts" rows="2" disabled>{{ data.analysts }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>                
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% include "includes/footer.html" %}
{% endblock content %}

{% block javascripts %}
<!-- Bootstrap JS (optional if not already included) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<!-- DataTables Buttons Print JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<!-- DataTables Buttons PDFMake JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<!-- DataTables Buttons VFS Fonts JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- DataTables Buttons CSV JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel'
                ]
            });
        });
    </script>
<script>
$(document).ready(function () {
    // Function to validate a single field
    function validateField(field) {
        const $field = $(field);
        const value = $field.val();
        const fieldName = $field.attr('name');
        
        // Clear existing errors
        $field.removeClass('is-invalid');
        $field.next('.invalid-feedback').remove();

        // Required fields validation (only Basic Information fields)
        const requiredFields = ['system_name', 'service_type', 'service_name', 'error_reason'];
        if (requiredFields.includes(fieldName) && !value.trim()) {
            $field.addClass('is-invalid');
            $field.after(`<div class="invalid-feedback">This field is required</div>`);
            return false;
        }

        // Optional field validations (only validate if there's a value)
        if (value.trim()) {
            switch (fieldName) {
                case 'system_name':
                    if (value.length > 50) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">System name cannot exceed 50 characters</div>`);
                        return false;
                    }
                    break;

                case 'service_type':
                case 'service_name':
                    if (value.length > 100) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 100 characters</div>`);
                        return false;
                    }
                    break;

                case 'priorite_numerique':
                    const prioNum = parseInt(value);
                    if (isNaN(prioNum) || prioNum < 1 || prioNum > 10) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Priority must be between 1 and 10</div>`);
                        return false;
                    }
                    break;

                case 'niveau_criticite':
                    const critNum = parseInt(value);
                    if (isNaN(critNum) || critNum < 1 || critNum > 5) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Criticality must be between 1 and 5</div>`);
                        return false;
                    }
                    break;

                case 'efficacite_solution':
                    if (value) {
                        const effNum = parseInt(value);
                        if (isNaN(effNum) || effNum < 0 || effNum > 100) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">Effectiveness must be between 0 and 100</div>`);
                            return false;
                        }
                    }
                    break;

                case 'charge_systeme':
                    if (value) {
                        const loadNum = parseInt(value);
                        if (isNaN(loadNum) || loadNum < 0 || loadNum > 100) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">System load must be between 0 and 100</div>`);
                            return false;
                        }
                    }
                    break;

                case 'impact_financier':
                    if (value && isNaN(parseInt(value))) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Please enter a valid number</div>`);
                        return false;
                    }
                    break;

                case 'nombre_utilisateurs_impactes':
                    if (value) {
                        const userNum = parseInt(value);
                        if (isNaN(userNum) || userNum < 0) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">Please enter a valid positive number</div>`);
                            return false;
                        }
                    }
                    break;

                // Character length validations for optional fields
                case 'code_erreur':
                case 'categorie_erreur':
                    if (value.length > 50) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 50 characters</div>`);
                        return false;
                    }
                    break;

                case 'zone_geographique_affectee':
                case 'canaux_communication':
                case 'impact_utilisateur':
                case 'frequence':
                case 'version_systeme':
                case 'etape_detection':
                    if (value.length > 100) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 100 characters</div>`);
                        return false;
                    }
                    break;
            }
        }

        return true;
    }

    // Fix checkbox IDs to be unique per modal
    $('[id^="errorFormModal"]').each(function() {
        const modalId = $(this).attr('id');
        const dataId = modalId.replace('errorFormModal', '');
        
        // Update checkbox IDs and their labels to be unique
        $(this).find('input[type="checkbox"]').each(function() {
            const originalId = $(this).attr('id');
            const newId = originalId + dataId;
            $(this).attr('id', newId);
            $(this).next('label').attr('for', newId);
        });
    });

    function showNotification(formId, message, type = 'success') {
        // Find the modal body which is the scrollable container
        const modalBody = $(`#${formId}`).closest('.modal-body');
        
        modalBody.animate({ scrollTop: 0 }, {
            duration: 200,  // Duration in milliseconds (10 seconds)
            easing: 'swing'
        });
        
        // Prepare the alert
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alert = `
            <div class="alert ${alertClass} alert-dismissible fade show mt-3" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        // Prepend the alert to the form
        $(`#${formId}`).prepend(alert);
        
        // Auto-hide the alert after 20 seconds
        setTimeout(() => {
            $(`#${formId} .alert`).fadeOut('slow', function() {
                $(this).remove();
            });
        }, 40000);
    }

    // Handle form submission
    $('form[id^="errorForm"]').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const formId = form.attr('id');
        let isValid = true;

        // Remove any existing alerts
        form.find('.alert').remove();

        // Validate all fields
        form.find('input, textarea, select').each(function() {
            if (!validateField(this)) {
                isValid = false;
            }
        });

        if (!isValid) {
            showNotification(formId, 'Please correct the errors in the form.', 'error');
            
            // Scroll to first error
            const firstError = form.find('.is-invalid').first();
            if (firstError.length) {
                firstError[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // Disable submit button and show loading state
        const submitBtn = form.find('button[type="submit"]');
        submitBtn.prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

        // Prepare form data
        const formData = new FormData(this);

        // Add checkbox values explicitly
        form.find('input[type="checkbox"]').each(function() {
            formData.set($(this).attr('name'), $(this).is(':checked'));
        });

        // Submit the form
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                showNotification(formId, response.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification(formId, response.message || 'An error occurred', 'error');
                    
                    if (response.errors) {
                        Object.entries(response.errors).forEach(([field, message]) => {
                            const fieldElement = form.find(`[name="${field}"]`);
                            fieldElement.addClass('is-invalid')
                                .after(`<div class="invalid-feedback">${message}</div>`);
                        });
                    }
                } catch (e) {
                    showNotification(formId, 'An unexpected error occurred', 'error');
                }
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('Submit');
            }
        });
    });

    // Clear validation errors when user starts typing/changing value
    $('form[id^="errorForm"] :input').on('input change', function() {
        $(this).removeClass('is-invalid')
            .next('.invalid-feedback').remove();
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const formId = '{{ data.id }}';
    let autoSaveTimeout;
    const form = document.getElementById(`errorForm${formId}`);

    // Update progress bar
    function updateProgress() {
        const inputs = form.querySelectorAll('input, select, textarea');
        let filled = 0;
        
        inputs.forEach(input => {
            if (input.value.trim() !== '') filled++;
        });
        
        const progress = (filled / inputs.length) * 100;
        const progressBar = form.querySelector('.progress-bar-fill');
        const progressText = form.querySelector('#progress-percentage');
        
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${Math.round(progress)}%`;
    }

    // Auto-save functionality
    form.addEventListener('input', (e) => {
        clearTimeout(autoSaveTimeout);
        
        const autoSaveStatus = document.querySelector('#autoSaveStatus');
        autoSaveStatus.innerHTML = '<i class="fas fa-sync fa-spin mr-1"></i> Saving...';
        
        autoSaveTimeout = setTimeout(() => {
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                autoSaveStatus.innerHTML = '<i class="fas fa-check mr-1"></i> Saved';
                document.querySelector(`#lastSaved${formId}`).textContent = 'Just now';
                
                setTimeout(() => {
                    autoSaveStatus.innerHTML = '<i class="fas fa-save mr-1"></i> Auto-saving';
                }, 2000);
            })
            .catch(error => {
                autoSaveStatus.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Save failed';
            });
            
            updateProgress();
        }, 1000);
    });

    // Collapse/Expand functionality
    document.querySelector('#collapseAll').addEventListener('click', () => {
        form.querySelectorAll('.collapse').forEach(section => {
            section.classList.remove('show');
        });
    });

    document.querySelector('#expandAll').addEventListener('click', () => {
        form.querySelectorAll('.collapse').forEach(section => {
            section.classList.add('show');
        });
    });

    // Initialize
    updateProgress();
});

</script>

{% endblock javascripts %}