{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Source DataTables {% endblock title %}

{% block extrastyle %}
<style>
    /* Custom CSS for table styling */
    #dataTable {
        width: 100%; /* Set table width to 100% */
        border-collapse: collapse; /* Collapse table borders */
        border: 1px solid #ddd; /* Add border to table */
    }
    
    #dataTable th, #dataTable td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 8px; /* Add padding to table cells */
    }

    #dataTable th {
        background-color: #f2f2f2; /* Set background color for table header */
    }

    #dataTable tbody tr:nth-child(even) {
        background-color: #f2f2f2; /* Set background color for even rows */
        color: rgb(0, 0, 0);
    }

    .is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem) !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 80%;
        margin-top: 0.25rem;
    }

    .alert {
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    .spinner-border {
        margin-right: 0.5rem;
    }

    /* Improve checkbox styling */
    .custom-control-input:checked ~ .custom-control-label::before {
        border-color: #007bff;
        background-color: #007bff;
    }

    .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .modal-lg {
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
        padding: 0.75rem 1.25rem;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .custom-select {
        border-radius: 0.25rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
    }
    
    .btn {
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-body {
    scroll-behavior: smooth;
    }
    
    .form-group label {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    </style>
{% endblock extrastyle %}

{% block extrahead %}
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <!-- DataTables CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <!-- DataTables Buttons CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extrahead %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Analysis Data</h1>
    <!-- Table responsive -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered mt-4" id="dataTable">
            <thead class="thead-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">System Name</th>
                    <th scope="col">Service Type</th>
                    <th scope="col">Service Name</th>
                    <th scope="col">Error Count</th>
                    <th scope="col">Error Reason</th>
                    <th scope="col">Source Timestamp</th>
                    <th scope="col">Error Form</th>
                </tr>
            </thead>
            <tbody>
                {% for data in fiche_erreurs %}
                <tr class="data-row">
                    <td>{{ data.id }}</td>
                    <td>{{ data.system_name }}</td>
                    <td>{{ data.service_type }}</td>
                    <td>{{ data.service_name }}</td>
                    <td>{{ data.error_count }}</td>
                    <td>{{ data.error_reason }}</td>
                    <td>{{ data.timestamp }}</td>
                    <!-- Button to trigger modal -->
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#errorFormModal{{ data.id }}">Open Form</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title font-weight-bold" id="errorFormModalLabel{{ data.id }}">
                    Error Form | System: {{ data.system_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="errorForm{{ data.id }}" action="{% url 'analysis:update_fiche_erreur' %}" method="POST">
                    {% csrf_token %}
                    
                    <!-- Basic Information Section -->
                    <div class="card mb-4 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Basic Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="system_name">System Name</label>
                                    <input type="text" class="form-control" id="system_name" name="system_name" value="{{ data.system_name }}" required disabled>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="service_type">Service Type</label>
                                    <input type="text" class="form-control" id="service_type" name="service_type" value="{{ data.service_type }}" required disabled>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="service_name">Service Name</label>
                                    <input type="text" class="form-control" id="service_name" name="service_name" value="{{ data.service_name }}" required disabled>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="error_reason">Error Reason</label>
                                    <textarea class="form-control" id="error_reason" name="error_reason" rows="3" disabled required>{{ data.error_reason }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Priority Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Status and Priority</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite">Priority</label>
                                    <select class="form-control" id="priorite" name="priorite">
                                        <option value="Normale" {% if data.priorite == "Normale" %}selected{% endif %}>Normal</option>
                                        <option value="Haute" {% if data.priorite == "Haute" %}selected{% endif %}>High</option>
                                        <option value="Urgente" {% if data.priorite == "Urgente" %}selected{% endif %}>Urgent</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite_numerique">Numerical Priority (1-5)</label>
                                    <input type="number" class="form-control" id="priorite_numerique" name="priorite_numerique" value="{{ data.priorite_numerique }}" min="1" max="5">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="niveau_criticite">Criticality Level (1-5)</label>
                                    <input type="number" class="form-control" id="niveau_criticite" name="niveau_criticite" value="{{ data.niveau_criticite }}" min="1" max="5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Error Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="symptomes_observes">Observed Symptoms</label>
                                    <textarea class="form-control" id="symptomes_observes" name="symptomes_observes" rows="3">{{ data.symptomes_observes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="logs_messages">Log Messages</label>
                                    <textarea class="form-control" id="logs_messages" name="logs_messages" rows="3">{{ data.logs_messages }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="services_affectes">Affected Services</label>
                                    <textarea class="form-control" id="services_affectes" name="services_affectes" rows="2">{{ data.services_affectes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="cause">Root Cause</label>
                                    <textarea class="form-control" id="cause" name="cause" rows="2">{{ data.cause }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Resolution Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_proposee">Proposed Solution</label>
                                    <textarea class="form-control" id="solution_proposee" name="solution_proposee" rows="3">{{ data.solution_proposee }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_implantee">Implemented Solution</label>
                                    <textarea class="form-control" id="solution_implantee" name="solution_implantee" rows="3">{{ data.solution_implantee }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="efficacite_solution">Solution Effectiveness (1-10)</label>
                                    <input type="number" class="form-control" id="efficacite_solution" name="efficacite_solution" value="{{ data.efficacite_solution }}" min="1" max="10">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="font-weight-bold" for="tests_effectues">Tests Performed</label>
                                    <textarea class="form-control" id="tests_effectues" name="tests_effectues" rows="2">{{ data.tests_effectues }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Technical Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="code_erreur">Error Code</label>
                                    <input type="text" class="form-control" id="code_erreur" name="code_erreur" value="{{ data.code_erreur }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="version_systeme">System Version</label>
                                    <input type="text" class="form-control" id="version_systeme" name="version_systeme" value="{{ data.version_systeme }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="charge_systeme">System Load (%)</label>
                                    <input type="number" class="form-control" id="charge_systeme" name="charge_systeme" value="{{ data.charge_systeme }}" step="0.01" min="0" max="100">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="fichiers_impactes">Impacted Files</label>
                                    <textarea class="form-control" id="fichiers_impactes" name="fichiers_impactes" rows="2">{{ data.fichiers_impactes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impact Assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Impact Assessment</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impact_financier">Financial Impact</label>
                                    <input type="number" class="form-control" id="impact_financier" name="impact_financier" value="{{ data.impact_financier }}" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="nombre_utilisateurs_impactes">Number of Users Affected</label>
                                    <input type="number" class="form-control" id="nombre_utilisateurs_impactes" name="nombre_utilisateurs_impactes" value="{{ data.nombre_utilisateurs_impactes }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="zone_geographique_affectee">Affected Geographical Area</label>
                                    <input type="text" class="form-control" id="zone_geographique_affectee" name="zone_geographique_affectee" value="{{ data.zone_geographique_affectee }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Communication and Collaboration -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Communication and Collaboration</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="canaux_communication">Communication Channels</label>
                                    <input type="text" class="form-control" id="canaux_communication" name="canaux_communication" value="{{ data.canaux_communication }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox mt-4">
                                        <input type="checkbox" class="custom-control-input" id="notifications_envoyees" name="notifications_envoyees" {% if data.notifications_envoyees %}checked{% endif %}>
                                        <label class="custom-control-label" for="notifications_envoyees">Notifications Sent</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="parties_prenantes">Stakeholders</label>
                                    <textarea class="form-control" id="parties_prenantes" name="parties_prenantes" rows="2">{{ data.parties_prenantes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Additional Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="analysts" name="analysts" {% if data.analysts %}checked{% endif %}>
                                        <label class="custom-control-label" for="analysts">Automatic Diagnosis/Correction Possible</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="resolution_automatique_possible" name="resolution_automatique_possible" {% if data.resolution_automatique_possible %}checked{% endif %}>
                                        <label class="custom-control-label" for="resolution_automatique_possible">Future Automation Possible</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysts -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">All Analysts</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="parties_prenantes">Analysts</label>
                                    <textarea class="form-control" id="parties_prenantes" name="parties_prenantes" rows="2" disabled>{{ data.analysts }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% include "includes/footer.html" %}
{% endblock content %}

{% block javascripts %}
<!-- Bootstrap JS (optional if not already included) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<!-- DataTables Buttons Print JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<!-- DataTables Buttons PDFMake JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<!-- DataTables Buttons VFS Fonts JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- DataTables Buttons CSV JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel'
                ]
            });
        });
    </script>
<script>
$(document).ready(function () {
    // Function to validate a single field
    function validateField(field) {
        const $field = $(field);
        const value = $field.val();
        const fieldName = $field.attr('name');
        
        // Clear existing errors
        $field.removeClass('is-invalid');
        $field.next('.invalid-feedback').remove();

        // Required fields validation (only Basic Information fields)
        const requiredFields = ['system_name', 'service_type', 'service_name', 'error_reason'];
        if (requiredFields.includes(fieldName) && !value.trim()) {
            $field.addClass('is-invalid');
            $field.after(`<div class="invalid-feedback">This field is required</div>`);
            return false;
        }

        // Optional field validations (only validate if there's a value)
        if (value.trim()) {
            switch (fieldName) {
                case 'system_name':
                    if (value.length > 50) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">System name cannot exceed 50 characters</div>`);
                        return false;
                    }
                    break;

                case 'service_type':
                case 'service_name':
                    if (value.length > 100) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 100 characters</div>`);
                        return false;
                    }
                    break;

                case 'priorite_numerique':
                    const prioNum = parseInt(value);
                    if (isNaN(prioNum) || prioNum < 1 || prioNum > 10) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Priority must be between 1 and 10</div>`);
                        return false;
                    }
                    break;

                case 'niveau_criticite':
                    const critNum = parseInt(value);
                    if (isNaN(critNum) || critNum < 1 || critNum > 5) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Criticality must be between 1 and 5</div>`);
                        return false;
                    }
                    break;

                case 'efficacite_solution':
                    if (value) {
                        const effNum = parseInt(value);
                        if (isNaN(effNum) || effNum < 0 || effNum > 100) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">Effectiveness must be between 0 and 100</div>`);
                            return false;
                        }
                    }
                    break;

                case 'charge_systeme':
                    if (value) {
                        const loadNum = parseInt(value);
                        if (isNaN(loadNum) || loadNum < 0 || loadNum > 100) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">System load must be between 0 and 100</div>`);
                            return false;
                        }
                    }
                    break;

                case 'impact_financier':
                    if (value && isNaN(parseInt(value))) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Please enter a valid number</div>`);
                        return false;
                    }
                    break;

                case 'nombre_utilisateurs_impactes':
                    if (value) {
                        const userNum = parseInt(value);
                        if (isNaN(userNum) || userNum < 0) {
                            $field.addClass('is-invalid');
                            $field.after(`<div class="invalid-feedback">Please enter a valid positive number</div>`);
                            return false;
                        }
                    }
                    break;

                // Character length validations for optional fields
                case 'code_erreur':
                case 'categorie_erreur':
                    if (value.length > 50) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 50 characters</div>`);
                        return false;
                    }
                    break;

                case 'zone_geographique_affectee':
                case 'canaux_communication':
                case 'impact_utilisateur':
                case 'frequence':
                case 'version_systeme':
                case 'etape_detection':
                    if (value.length > 100) {
                        $field.addClass('is-invalid');
                        $field.after(`<div class="invalid-feedback">Cannot exceed 100 characters</div>`);
                        return false;
                    }
                    break;
            }
        }

        return true;
    }

    // Fix checkbox IDs to be unique per modal
    $('[id^="errorFormModal"]').each(function() {
        const modalId = $(this).attr('id');
        const dataId = modalId.replace('errorFormModal', '');
        
        // Update checkbox IDs and their labels to be unique
        $(this).find('input[type="checkbox"]').each(function() {
            const originalId = $(this).attr('id');
            const newId = originalId + dataId;
            $(this).attr('id', newId);
            $(this).next('label').attr('for', newId);
        });
    });

    function showNotification(formId, message, type = 'success') {
        // Find the modal body which is the scrollable container
        const modalBody = $(`#${formId}`).closest('.modal-body');
        
        modalBody.animate({ scrollTop: 0 }, {
            duration: 200,  // Duration in milliseconds (10 seconds)
            easing: 'swing'
        });
        
        // Prepare the alert
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alert = `
            <div class="alert ${alertClass} alert-dismissible fade show mt-3" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        // Prepend the alert to the form
        $(`#${formId}`).prepend(alert);
        
        // Auto-hide the alert after 20 seconds
        setTimeout(() => {
            $(`#${formId} .alert`).fadeOut('slow', function() {
                $(this).remove();
            });
        }, 40000);
    }

    // Handle form submission
    $('form[id^="errorForm"]').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const formId = form.attr('id');
        let isValid = true;

        // Remove any existing alerts
        form.find('.alert').remove();

        // Validate all fields
        form.find('input, textarea, select').each(function() {
            if (!validateField(this)) {
                isValid = false;
            }
        });

        if (!isValid) {
            showNotification(formId, 'Please correct the errors in the form.', 'error');
            
            // Scroll to first error
            const firstError = form.find('.is-invalid').first();
            if (firstError.length) {
                firstError[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // Disable submit button and show loading state
        const submitBtn = form.find('button[type="submit"]');
        submitBtn.prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

        // Prepare form data
        const formData = new FormData(this);

        // Add checkbox values explicitly
        form.find('input[type="checkbox"]').each(function() {
            formData.set($(this).attr('name'), $(this).is(':checked'));
        });

        // Submit the form
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                showNotification(formId, response.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification(formId, response.message || 'An error occurred', 'error');
                    
                    if (response.errors) {
                        Object.entries(response.errors).forEach(([field, message]) => {
                            const fieldElement = form.find(`[name="${field}"]`);
                            fieldElement.addClass('is-invalid')
                                .after(`<div class="invalid-feedback">${message}</div>`);
                        });
                    }
                } catch (e) {
                    showNotification(formId, 'An unexpected error occurred', 'error');
                }
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('Submit');
            }
        });
    });

    // Clear validation errors when user starts typing/changing value
    $('form[id^="errorForm"] :input').on('input change', function() {
        $(this).removeClass('is-invalid')
            .next('.invalid-feedback').remove();
    });
});
</script>

{% endblock javascripts %}