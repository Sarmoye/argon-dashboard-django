{% extends 'layouts/base.html' %}

{% load static %}

{% block title %} Source DataTables {% endblock title %}

{% block extrastyle %}
<style>
    /* Custom CSS for table styling */
    #dataTable {
        width: 100%; /* Set table width to 100% */
        border-collapse: collapse; /* Collapse table borders */
        border: 1px solid #ddd; /* Add border to table */
    }
    #dataTable th, #dataTable td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 8px; /* Add padding to table cells */
    }
    #dataTable th {
        background-color: #f2f2f2; /* Set background color for table header */
    }
    #dataTable tbody tr:nth-child(even) {
        background-color: #f2f2f2; /* Set background color for even rows */
        color: rgb(0, 0, 0);
    }
</style>
<style>
    .modal-lg {
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 0.5rem;
    }
    
    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
        padding: 0.75rem 1.25rem;
    }
    
    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .custom-select {
        border-radius: 0.25rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
    }
    
    .btn {
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .form-group label {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    </style>
{% endblock extrastyle %}

{% block extrahead %}
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <!-- DataTables CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <!-- DataTables Buttons CSS -->
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
{% endblock extrahead %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Analysis Data</h1>
    <!-- Table responsive -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered mt-4" id="dataTable">
            <thead class="thead-light">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">System Name</th>
                    <th scope="col">Service Type</th>
                    <th scope="col">Service Name</th>
                    <th scope="col">Error Count</th>
                    <th scope="col">Error Reason</th>
                    <th scope="col">Source Timestamp</th>
                    <th scope="col">Error Form</th>
                </tr>
            </thead>
            <tbody>
                {% for data in fiche_erreurs %}
                <tr class="data-row">
                    <td>{{ data.id }}</td>
                    <td>{{ data.system_name }}</td>
                    <td>{{ data.service_type }}</td>
                    <td>{{ data.service_name }}</td>
                    <td>{{ data.error_count }}</td>
                    <td>{{ data.error_reason }}</td>
                    <td>{{ data.timestamp }}</td>
                    <!-- Button to trigger modal -->
                    <td><button class="btn btn-primary" data-toggle="modal" data-target="#errorFormModal{{ data.id }}">Open Form</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Template (dynamically rendered for each row) -->
{% for data in fiche_erreurs %}
<div class="modal fade" id="errorFormModal{{ data.id }}" tabindex="-1" role="dialog" aria-labelledby="errorFormModalLabel{{ data.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title font-weight-bold" id="errorFormModalLabel{{ data.id }}">
                    Error Form | System: {{ data.system_name }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="errorForm{{ data.id }}" action="{% url 'analysis:update_fiche_erreur' %}" method="POST">
                    {% csrf_token %}
                    
                    <!-- Basic Information Section -->
                    <div class="card mb-4 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Basic Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="system_name">System Name</label>
                                    <input type="text" class="form-control" id="system_name" name="system_name" value="{{ data.system_name }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="service_type">Service Type</label>
                                    <input type="text" class="form-control" id="service_type" name="service_type" value="{{ data.service_type }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="service_name">Service Name</label>
                                    <input type="text" class="form-control" id="service_name" name="service_name" value="{{ data.service_name }}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="error_reason">Error Reason</label>
                                    <textarea class="form-control" id="error_reason" name="error_reason" rows="3" required>{{ data.error_reason }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Priority Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Status and Priority</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite">Priority</label>
                                    <select class="form-control" id="priorite" name="priorite">
                                        <option value="Normale" {% if data.priorite == "Normale" %}selected{% endif %}>Normal</option>
                                        <option value="Haute" {% if data.priorite == "Haute" %}selected{% endif %}>High</option>
                                        <option value="Urgente" {% if data.priorite == "Urgente" %}selected{% endif %}>Urgent</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="priorite_numerique">Numerical Priority (1-5)</label>
                                    <input type="number" class="form-control" id="priorite_numerique" name="priorite_numerique" value="{{ data.priorite_numerique }}" min="1" max="5">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="niveau_criticite">Criticality Level (1-5)</label>
                                    <input type="number" class="form-control" id="niveau_criticite" name="niveau_criticite" value="{{ data.niveau_criticite }}" min="1" max="5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Details Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Error Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="symptomes_observes">Observed Symptoms</label>
                                    <textarea class="form-control" id="symptomes_observes" name="symptomes_observes" rows="3">{{ data.symptomes_observes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="logs_messages">Log Messages</label>
                                    <textarea class="form-control" id="logs_messages" name="logs_messages" rows="3">{{ data.logs_messages }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="services_affectes">Affected Services</label>
                                    <textarea class="form-control" id="services_affectes" name="services_affectes" rows="2">{{ data.services_affectes }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="cause">Root Cause</label>
                                    <textarea class="form-control" id="cause" name="cause" rows="2">{{ data.cause }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Resolution Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_proposee">Proposed Solution</label>
                                    <textarea class="form-control" id="solution_proposee" name="solution_proposee" rows="3">{{ data.solution_proposee }}</textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="solution_implantee">Implemented Solution</label>
                                    <textarea class="form-control" id="solution_implantee" name="solution_implantee" rows="3">{{ data.solution_implantee }}</textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="efficacite_solution">Solution Effectiveness (1-10)</label>
                                    <input type="number" class="form-control" id="efficacite_solution" name="efficacite_solution" value="{{ data.efficacite_solution }}" min="1" max="10">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="font-weight-bold" for="tests_effectues">Tests Performed</label>
                                    <textarea class="form-control" id="tests_effectues" name="tests_effectues" rows="2">{{ data.tests_effectues }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Technical Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="code_erreur">Error Code</label>
                                    <input type="text" class="form-control" id="code_erreur" name="code_erreur" value="{{ data.code_erreur }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="version_systeme">System Version</label>
                                    <input type="text" class="form-control" id="version_systeme" name="version_systeme" value="{{ data.version_systeme }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="font-weight-bold" for="charge_systeme">System Load (%)</label>
                                    <input type="number" class="form-control" id="charge_systeme" name="charge_systeme" value="{{ data.charge_systeme }}" step="0.01" min="0" max="100">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="fichiers_impactes">Impacted Files</label>
                                    <textarea class="form-control" id="fichiers_impactes" name="fichiers_impactes" rows="2">{{ data.fichiers_impactes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Impact Assessment -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Impact Assessment</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="impact_financier">Financial Impact</label>
                                    <input type="number" class="form-control" id="impact_financier" name="impact_financier" value="{{ data.impact_financier }}" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="nombre_utilisateurs_impactes">Number of Users Affected</label>
                                    <input type="number" class="form-control" id="nombre_utilisateurs_impactes" name="nombre_utilisateurs_impactes" value="{{ data.nombre_utilisateurs_impactes }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="zone_geographique_affectee">Affected Geographical Area</label>
                                    <input type="text" class="form-control" id="zone_geographique_affectee" name="zone_geographique_affectee" value="{{ data.zone_geographique_affectee }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Communication and Collaboration -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Communication and Collaboration</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="font-weight-bold" for="canaux_communication">Communication Channels</label>
                                    <input type="text" class="form-control" id="canaux_communication" name="canaux_communication" value="{{ data.canaux_communication }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox mt-4">
                                        <input type="checkbox" class="custom-control-input" id="notifications_envoyees" name="notifications_envoyees" {% if data.notifications_envoyees %}checked{% endif %}>
                                        <label class="custom-control-label" for="notifications_envoyees">Notifications Sent</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="font-weight-bold" for="parties_prenantes">Stakeholders</label>
                                    <textarea class="form-control" id="parties_prenantes" name="parties_prenantes" rows="2">{{ data.parties_prenantes }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Additional Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="automatisation_possible" name="automatisation_possible" {% if data.automatisation_possible %}checked{% endif %}>
                                        <label class="custom-control-label" for="automatisation_possible">Automatic Diagnosis/Correction Possible</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="resolution_automatique_possible" name="resolution_automatique_possible" {% if data.resolution_automatique_possible %}checked{% endif %}>
                                        <label class="custom-control-label" for="resolution_automatique_possible">Future Automation Possible</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="data_id" value="{{ data.id }}">
                    <div class="text-right">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% include "includes/footer.html" %}
{% endblock content %}

{% block javascripts %}
<!-- Bootstrap JS (optional if not already included) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<!-- DataTables Buttons Print JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<!-- DataTables Buttons PDFMake JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<!-- DataTables Buttons VFS Fonts JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- DataTables Buttons CSV JS -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<!-- DataTables Buttons Flash JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel'
                ]
            });
        });
    </script>
<script>
    $(document).ready(function () {
        // Bind the form submit event
        $('form[id^="errorForm"]').on('submit', function (e) {
            e.preventDefault(); // Prevent the default form submission

            var form = $(this);
            var formData = new FormData(this); // Collect the form data

            // Disable the submit button to prevent multiple submissions
            form.find('button[type="submit"]').prop('disabled', true);

            $.ajax({
                url: form.attr('action'),  // Form action URL
                type: 'POST',              // Method type
                data: formData,            // Send the form data
                processData: false,        // Don't process the data
                contentType: false,        // Don't set content type
                success: function (response) {
                    // Handle success (e.g., show a success message)
                    alert('Form submitted successfully!');
                    // Optionally, close the modal after successful submission
                    $('#errorFormModal{{ data.id }}').modal('hide');
                },
                error: function(xhr, errmsg, err) {
                    console.log('Error:', xhr.responseText); // Log the response for debugging
                    alert('There was an error submitting the form: ' + xhr.responseText);
                },
                complete: function () {
                    // Re-enable the submit button after AJAX request is complete
                    form.find('button[type="submit"]').prop('disabled', false);
                }
            });
        });
    });
</script>

{% endblock javascripts %}