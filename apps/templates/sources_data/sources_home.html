    {% extends 'layouts/base.html' %}

    {% load static %}

    {% block title %} Source DataTables {% endblock title %}

    {% block stylesheets %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        /* Style pour rendre la table responsive avec défilement horizontal */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
    {% endblock stylesheets %}

    {% block content %}
    <!DOCTYPE html>
    <html lang="en">
    <body>
        <div class="container mt-5">
            <h1 class="text-center">Source Data</h1>

            <!-- Barre de recherche et nombre d'entrées par page -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search...">
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary" id="addButton">Add New Data</button>
                    <button class="btn btn-secondary" id="filterButton" data-bs-toggle="collapse" data-bs-target="#filterOptions" aria-expanded="false" aria-controls="filterOptions">Filter Data</button>
                </div>
            </div>

            <!-- Options de filtrage -->
            <div class="collapse" id="filterOptions">
                <div class="card card-body mb-3">
                    <label for="filterField">Filter by:</label>
                    <select class="form-select" id="filterField">
                        <option value="">Select field</option>
                        <option value="system_name">System Name</option>
                        <option value="domain">Domain</option>
                        <option value="service_type">Service Type</option>
                        <option value="service_name">Service Name</option>
                        <option value="error_count">Error Count</option>
                        <option value="error_reason">Error Reason</option>
                        <option value="source_type">Source Type</option>
                        <option value="timestamp">Timestamp</option>
                        <option value="validation_status">Validation Status</option>
                        <option value="processed_flag">Processed Flag</option>
                        <option value="admin_notes">Admin Notes</option>
                        <option value="inserted_by">Inserted By</option>
                    </select>
                    <input type="text" class="form-control mt-2" id="filterInput" placeholder="Enter filter text">
                </div>
            </div>

            <!-- Sélecteur pour le nombre d'entrées par page -->
            <div class="mb-3">
                <label for="entriesPerPage">Entries per page:</label>
                <select class="form-select" id="entriesPerPage">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>

            <!-- Bouton VALIDATION -->
            <div class="text-end mb-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#validationModal">VALIDATION</button>
            </div>

            <!-- Modal VALIDATION -->
            <div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="validationModalLabel">Apply Validation</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="validationForm">
                                <!-- Sélection de la date -->
                                <div class="mb-3">
                                    <label for="validationDate" class="form-label">Select Date (YYYY-MM-DD):</label>
                                    <input type="date" class="form-control" id="validationDate" required>
                                </div>

                                <!-- Sélection du statut -->
                                <div class="mb-3">
                                    <label for="validationStatus" class="form-label">Validation Status:</label>
                                    <select class="form-select" id="validationStatus" required>
                                        <option value="Pending">Pending</option>
                                        <option value="Validated">Validated</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>

                                <!-- Notes administratives -->
                                <div class="mb-3">
                                    <label for="adminNotes" class="form-label">Admin Notes:</label>
                                    <textarea class="form-control" id="adminNotes" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="applyValidationButton">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table responsive -->
            <div class="table-responsive">
                <table class="table table-striped table-bordered mt-4" id="dataTable">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">System Name</th>
                            <th scope="col">Domain</th>
                            <th scope="col">Service Type</th>
                            <th scope="col">Service Name</th>
                            <th scope="col">Error Count</th>
                            <th scope="col">Error Reason</th>
                            <th scope="col">Source Type</th>
                            <th scope="col">Timestamp</th>
                            <th scope="col">Validation Status</th>
                            <th scope="col">Processed Flag</th>
                            <th scope="col">Admin Notes</th>
                            <th scope="col">Inserted By</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in source_data %}
                        <tr class="data-row">
                            <td>{{ data.id }}</td>
                            <td>{{ data.system_name }}</td>
                            <td>{{ data.domain }}</td>
                            <td>{{ data.service_type }}</td>
                            <td>{{ data.service_name }}</td>
                            <td>{{ data.error_count }}</td>
                            <td>{{ data.error_reason }}</td>
                            <td>{{ data.source_type }}</td>
                            <td>{{ data.timestamp }}</td>
                            <td>{{ data.validation_status }}</td>
                            <td>{{ data.processed_flag }}</td>
                            <td>{{ data.admin_notes }}</td>
                            <td>{{ data.inserted_by }}</td>
                            <td class="text-right">
                                <div class="dropdown">
                                <a class="btn btn-sm btn-icon-only text-light" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                                    <a class="dropdown-item" href="#">Edit</a>
                                </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="13" class="text-center">No data available.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- JavaScript pour la recherche et le nombre d'entrées par page -->
        <script>
            // Fonction de recherche
            document.getElementById('searchInput').addEventListener('keyup', function() {
                var input = document.getElementById('searchInput').value.toLowerCase();
                var rows = document.getElementById('dataTable').getElementsByTagName('tr');

                for (var i = 1; i < rows.length; i++) {
                    var cells = rows[i].getElementsByTagName('td');
                    var found = false;

                    for (var j = 0; j < cells.length; j++) {
                        if (cells[j].textContent.toLowerCase().indexOf(input) > -1) {
                            found = true;
                            break;
                        }
                    }

                    if (found) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            });

            // Fonction de filtrage dynamique
            document.getElementById('filterInput').addEventListener('input', function() {
                var filterField = document.getElementById('filterField').value;
                var filterValue = document.getElementById('filterInput').value.toLowerCase();
                var rows = document.getElementById('dataTable').getElementsByTagName('tr');

                for (var i = 1; i < rows.length; i++) {
                    var cells = rows[i].getElementsByTagName('td');
                    var cellValue;

                    // Sélectionner la cellule correspondante au filtre choisi
                    switch (filterField) {
                        case 'system_name': cellValue = cells[1]; break;
                        case 'domain': cellValue = cells[2]; break;
                        case 'service_type': cellValue = cells[3]; break;
                        case 'service_name': cellValue = cells[4]; break;
                        case 'error_count': cellValue = cells[5]; break;
                        case 'error_reason': cellValue = cells[6]; break;
                        case 'source_type': cellValue = cells[7]; break;
                        case 'timestamp': cellValue = cells[8]; break;
                        case 'validation_status': cellValue = cells[9]; break;
                        case 'processed_flag': cellValue = cells[10]; break;
                        case 'admin_notes': cellValue = cells[11]; break;
                        case 'inserted_by': cellValue = cells[12]; break;
                        default: cellValue = null;
                    }

                    // Vérifier si le texte dans la cellule correspond au filtre
                    if (filterValue === "" || (cellValue && cellValue.textContent.toLowerCase().includes(filterValue))) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            });

            // Fonction pour gérer l'affichage des lignes en fonction du nombre d'entrées par page
            document.getElementById('entriesPerPage').addEventListener('change', function() {
                var entriesPerPage = parseInt(this.value);
                var rows = document.getElementById('dataTable').getElementsByTagName('tr');
                for (var i = 1; i < rows.length; i++) {
                    rows[i].style.display = 'none'; // Cacher toutes les lignes
                }

                // Afficher les lignes en fonction de l'option sélectionnée
                for (var i = 1; i <= entriesPerPage && i < rows.length; i++) {
                    rows[i].style.display = '';
                }
            });

            // Initialiser avec 10 entrées par page
            document.getElementById('entriesPerPage').value = '10';
            document.getElementById('entriesPerPage').dispatchEvent(new Event('change'));
        </script>

    </body>
    </html>

    {% include "includes/footer.html" %}
    {% endblock content %}

    <!-- Specific JS goes HERE --> 
    {% block javascripts %}
    <script>
        document.getElementById('applyValidationButton').addEventListener('click', function () {
            const validationDate = document.getElementById('validationDate').value;
            const validationStatus = document.getElementById('validationStatus').value;
            const adminNotes = document.getElementById('adminNotes').value;
    
            if (!validationDate || !validationStatus) {
                alert("Please fill in all required fields.");
                return;
            }
    
            // Envoi des données au serveur via Fetch API
            fetch('/apply-validation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    validation_date: validationDate,
                    validation_status: validationStatus,
                    admin_notes: adminNotes,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Validation applied successfully!");
                    window.location.reload();
                } else {
                    alert("Error applying validation: " + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
    {% endblock javascripts %}
