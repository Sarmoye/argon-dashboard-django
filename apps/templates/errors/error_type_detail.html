{% extends 'layouts/base.html' %}

{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Type d'erreur: {{ error_type.system_name }}</h2>
        <div>
            <a href="{% url 'ems_app:error_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>
            <a href="{% url 'ems_app:add_occurrence' type_id=error_type.id %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Ajouter une occurrence
            </a>
            <a href="{% url 'ems_app:edit_error_type' type_id=error_type.id %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Modifier
            </a>
        </div>
    </div>
    
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Informations générales
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> {{ error_type.id }}</p>
                    <p><strong>Système:</strong> {{ error_type.system_name }}</p>
                    <p><strong>Type de service:</strong> {{ error_type.service_type }}</p>
                    <p><strong>Service:</strong> {{ error_type.service_name }}</p>
                    <p><strong>Code d'erreur:</strong> {{ error_type.code_erreur|default:"Non spécifié" }}</p>
                    <p><strong>Niveau de sévérité:</strong> {{ error_type.niveau_severite|default:"Non spécifié" }}</p>
                    <p><strong>Date de création:</strong> {{ error_type.created_at|date:"d/m/Y H:i" }}</p>
                    <p><strong>Dernière mise à jour:</strong> {{ error_type.updated_at|date:"d/m/Y H:i" }}</p>
                    
                    <div class="mt-3">
                        <h5>Raison de l'erreur:</h5>
                        <p>{{ error_type.error_reason|linebreaks }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Informations techniques
                </div>
                <div class="card-body">
                    {% if error_type.fichiers_impactes %}
                    <div class="mb-3">
                        <h5>Fichiers/modules impactés:</h5>
                        <p>{{ error_type.fichiers_impactes|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if error_type.description_technique %}
                    <div class="mb-3">
                        <h5>Description technique:</h5>
                        <p>{{ error_type.description_technique|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if error_type.logs %}
                    <div class="mb-3">
                        <h5>Messages de logs:</h5>
                        <pre class="bg-light p-3">{{ error_type.logs }}</pre>
                    </div>
                    {% endif %}
                    
                    {% if error_type.comportement_attendu %}
                    <div class="mb-3">
                        <h5>Comportement attendu:</h5>
                        <p>{{ error_type.comportement_attendu|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if error_type.procedures_contournement %}
                    <div class="mb-3">
                        <h5>Procédures de contournement:</h5>
                        <p>{{ error_type.procedures_contournement|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if error_type.environnement %}
                    <div class="mb-3">
                        <h5>Environnement:</h5>
                        <p>{{ error_type.environnement }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% if ticket %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Ticket de suivi
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Statut:</strong> 
                        <span class="badge 
                            {% if ticket.statut == 'OPEN' %}bg-danger{% endif %}
                            {% if ticket.statut == 'IN_PROGRESS' %}bg-warning{% endif %}
                            {% if ticket.statut == 'PENDING' %}bg-info{% endif %}
                            {% if ticket.statut == 'RESOLVED' %}bg-success{% endif %}
                            {% if ticket.statut == 'CLOSED' %}bg-secondary{% endif %}">
                            {{ ticket.get_statut_display }}
                        </span>
                    </p>
                    <p><strong>Priorité:</strong> {{ ticket.get_priorite_display }}</p>
                    <p><strong>Criticité:</strong> {{ ticket.niveau_criticite }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Date de création:</strong> {{ ticket.date_creation|date:"d/m/Y H:i" }}</p>
                    <p><strong>Dernière modification:</strong> {{ ticket.date_modification|date:"d/m/Y H:i" }}</p>
                    {% if ticket.date_resolution %}
                    <p><strong>Date de résolution:</strong> {{ ticket.date_resolution|date:"d/m/Y H:i" }}</p>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <p><strong>Responsable:</strong> {{ ticket.responsable|default:"Non assigné" }}</p>
                    <p><strong>Équipe:</strong> {{ ticket.equipe|default:"Non assignée" }}</p>
                    <p><strong>Durée:</strong> {{ ticket.get_duration }} heures</p>
                </div>
            </div>
            
            <div class="mt-3">
                <h5>Symptômes:</h5>
                <p>{{ ticket.symptomes|linebreaks }}</p>
            </div>
            
            {% if ticket.impact %}
            <div class="mt-3">
                <h5>Impact:</h5>
                <p>{{ ticket.impact|linebreaks }}</p>
            </div>
            {% endif %}
            
            {% if ticket.cause_racine %}
            <div class="mt-3">
                <h5>Cause racine:</h5>
                <p>{{ ticket.cause_racine|linebreaks }}</p>
            </div>
            {% endif %}
            
            {% if ticket.solution %}
            <div class="mt-3">
                <h5>Solution:</h5>
                <p>{{ ticket.solution|linebreaks }}</p>
            </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <a href="{% url 'ems_app:update_ticket' ticket_id=ticket.id %}" class="btn btn-warning btn-sm">
                Mettre à jour le ticket
            </a>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-4">
        <p>Aucun ticket de suivi n'a été créé pour ce type d'erreur.</p>
        <a href="{% url 'ems_app:create_ticket' type_id=error_type.id %}" class="btn btn-warning btn-sm">
            Créer un ticket
        </a>
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            Occurrences ({{ event_count }})
        </div>
        <div class="card-body">
            {% if events %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date/Heure</th>
                            <th>Nombre d'erreurs</th>
                            <th>Signalé par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td>{{ event.id }}</td>
                            <td>{{ event.timestamp|date:"d/m/Y H:i" }}</td>
                            <td>{{ event.error_count }}</td>
                            <td>{{ event.inserted_by }}</td>
                            <td>
                                <a href="{% url 'ems_app:error_detail' error_id=event.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                Aucune occurrence pour ce type d'erreur.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}