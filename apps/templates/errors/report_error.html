{% extends 'layouts/base.html' %}

{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Signaler une erreur</h2>
    
    <div class="alert alert-info">
        <p>Cette page vous permet de signaler une erreur. Le système déterminera automatiquement s'il s'agit d'une nouvelle erreur ou d'une erreur déjà connue.</p>
    </div>
    
    <form method="post" action="{% url 'ems_app:report_error' %}">
        {% csrf_token %}
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                Informations sur l'erreur
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="{{ form.system_name.id_for_label }}">Nom du système*</label>
                    {{ form.system_name }}
                    {% if form.system_name.errors %}
                    <div class="text-danger">{{ form.system_name.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.service_type.id_for_label }}">Type de service*</label>
                    {{ form.service_type }}
                    {% if form.service_type.errors %}
                    <div class="text-danger">{{ form.service_type.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.service_name.id_for_label }}">Nom du service*</label>
                    {{ form.service_name }}
                    {% if form.service_name.errors %}
                    <div class="text-danger">{{ form.service_name.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.error_reason.id_for_label }}">Raison de l'erreur*</label>
                    {{ form.error_reason }}
                    {% if form.error_reason.errors %}
                    <div class="text-danger">{{ form.error_reason.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.error_count.id_for_label }}">Nombre d'erreurs*</label>
                    {{ form.error_count }}
                    {% if form.error_count.errors %}
                    <div class="text-danger">{{ form.error_count.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.inserted_by.id_for_label }}">Signalé par*</label>
                    {{ form.inserted_by }}
                    {% if form.inserted_by.errors %}
                    <div class="text-danger">{{ form.inserted_by.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group mb-3">
                    <label for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                    <div class="text-danger">{{ form.notes.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Signaler l'erreur</button>
                <a href="{% url 'ems_app:error_list' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
<!-- Avant la fermeture de la balise </body> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    // Ajouter ce code à la fin de votre template report_error.html juste avant la fermeture de la balise </body>
$(document).ready(function() {
    // Sélectionner le formulaire
    const reportErrorUrl = "{% url 'ems_app:report_error' %}";
    const $errorForm = $('form[action="' + reportErrorUrl + '"]');
    
    // Ajouter un gestionnaire d'événement pour la soumission du formulaire
    $errorForm.on('submit', function(e) {
        e.preventDefault(); // Empêcher la soumission normale du formulaire
        
        // Afficher un indicateur de chargement
        const $submitBtn = $(this).find('button[type="submit"]');
        const originalBtnText = $submitBtn.text();
        $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Traitement en cours...');
        
        // Récupérer le token CSRF
        const csrftoken = $('[name="csrfmiddlewaretoken"]').val();
        
        // Sérialiser les données du formulaire
        const formData = $(this).serialize();
        
        // Soumission AJAX
        $.ajax({
            url: $errorForm.attr('action'),
            type: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': csrftoken
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    // Afficher un message de succès
                    const alertClass = response.is_new_type ? 'alert-success' : 'alert-info';
                    const message = response.message || "Erreur signalée avec succès";
                    
                    // Ajouter une notification en haut du formulaire
                    $errorForm.before(`
                        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `);
                    
                    // Rediriger vers la page de détails après un court délai
                    if (response.redirect_url) {
                        setTimeout(function() {
                            window.location.href = response.redirect_url;
                        }, 1500);
                    }
                } else {
                    // Afficher les erreurs de validation
                    displayFormErrors(response.errors);
                }
            },
            error: function(xhr, status, error) {
                // Gérer les erreurs de requête
                $errorForm.before(`
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        Une erreur s'est produite lors du traitement de votre demande. Veuillez réessayer.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);
                console.error("Erreur AJAX:", error);
            },
            complete: function() {
                // Réactiver le bouton de soumission
                $submitBtn.prop('disabled', false).text(originalBtnText);
            }
        });
    });
    
    // Fonction pour afficher les erreurs de validation sur les champs
    function displayFormErrors(errors) {
        // Effacer les erreurs précédentes
        $('.text-danger').remove();
        $('.is-invalid').removeClass('is-invalid');
        
        // Afficher les nouvelles erreurs
        for (const field in errors) {
            const $field = $(`#id_${field}`);
            const errorMsg = errors[field].join('<br>');
            
            $field.addClass('is-invalid');
            $field.after(`<div class="text-danger">${errorMsg}</div>`);
        }
        
        // Faire défiler jusqu'à la première erreur
        if (Object.keys(errors).length > 0) {
            const firstField = Object.keys(errors)[0];
            $(`#id_${firstField}`)[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
});
</script>
{% endblock javascripts %}