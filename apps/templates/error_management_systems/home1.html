{% extends 'layouts/base.html' %}

{% load static %}

{% block title %}Home - Error Management System{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extrahead %}

{% block content %}
    <h1>Dashboard</h1>

    <div>
        <h2>Overview</h2>
        <p>Total Error Types: {{ stats.total_error_types }}</p>
        <p>Total Error Events: {{ stats.total_error_events }}</p>
        <p>Open Tickets: {{ stats.open_tickets }}</p>
        <p>Resolved Tickets: {{ stats.resolved_tickets }}</p>
        <p>Average Resolution Time: {{ stats.average_resolution_time }} hours</p>

        <h3>Recent Events</h3>
        <ul>
            {% for event in stats.recent_events %}
                <li>{{ event.timestamp }}: {{ event.system_name }} - {{ event.error_reason|truncatechars:50 }}</li>
            {% endfor %}
        </ul>

        <h3>Top Errors</h3>
        <ul>
            {% for error in stats.top_errors %}
                <li>{{ error.system_name }}: {{ error.error_reason|truncatechars:50 }} ({{ error.event_count }} events)</li>
            {% endfor %}
        </ul>

        <h3>Critical Tickets</h3>
        <ul>
            {% for ticket in stats.critical_tickets %}
                <li>{{ ticket.ticket_reference }}: {{ ticket.error_type.system_name }} - {{ ticket.get_priorite_display }}</li>
            {% endfor %}
        </ul>
    </div>

    <div>
        <h2>Charts and Trends</h2>

        <div style="width: 600px; margin: 20px;">
            <h3>Error Event Trend (Last 7 Days)</h3>
            <canvas id="eventTrendChart"
                    data-labels="{{ stats.event_trend|safe|escape }}"
                    data-data="{{ stats.event_trend|safe|escape }}">
            </canvas>
        </div>

        <div style="width: 600px; margin: 20px;">
            <h3>Error Type Distribution (by System Name)</h3>
            <canvas id="errorTypeDistributionChart"
                    data-labels="{{ stats.error_type_distribution|safe|escape }}"
                    data-data="{{ stats.error_type_distribution|safe|escape }}">
            </canvas>
        </div>

        <div style="width: 600px; margin: 20px;">
            <h3>Priority Breakdown</h3>
            <canvas id="priorityBreakdownChart"
                    data-labels="{{ stats.priority_breakdown|safe|escape }}"
                    data-data="{{ stats.priority_breakdown|safe|escape }}">
            </canvas>
        </div>

        <div style="width: 600px; margin: 20px;">
            <h3>Status Breakdown</h3>
            <canvas id="statusBreakdownChart"
                    data-labels="{{ stats.status_breakdown|safe|escape }}"
                    data-data="{{ stats.status_breakdown|safe|escape }}">
            </canvas>
        </div>

        <div style="width: 600px; margin: 20px;">
            <h3>Severity Distribution</h3>
            <canvas id="severityDistributionChart"
                    data-labels="{{ stats.severity_distribution|safe|escape }}"
                    data-data="{{ stats.severity_distribution|safe|escape }}">
            </canvas>
        </div>

    </div>

{% endblock %}
{% block javascripts %}
<script>
    function createChart(canvasId, chartType, labelKey, dataKey, backgroundColor, borderColor) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        let labels = JSON.parse(canvas.dataset.labels.replace(/&quot;/g, '"')).map(item => item[labelKey]);
        let data = JSON.parse(canvas.dataset.data.replace(/&quot;/g, '"')).map(item => item[dataKey]);
        let backgroundColors = backgroundColor;
        let borderColors = borderColor;

        if (!Array.isArray(backgroundColor)) {
            backgroundColors = data.map(() => backgroundColor);
        }
        if (!Array.isArray(borderColor)) {
            borderColors = data.map(() => borderColor);
        }

        new Chart(ctx, {
            type: chartType,
            data: {
                labels: labels,
                datasets: [{
                    label: canvas.id.replace('Chart', '').replace(/([A-Z])/g, ' $1').trim(),
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: chartType !== 'pie'
                    }
                }
            }
        });
    }

    // Error Event Trend
    createChart('eventTrendChart', 'line', 'date', 'count', 'rgb(75, 192, 192)', 'rgb(75, 192, 192)');

    // Error Type Distribution
    createChart('errorTypeDistributionChart', 'bar', 'system_name', 'count', 'rgba(54, 162, 235, 0.5)', 'rgb(54, 162, 235)');

    // Priority Breakdown
    createChart('priorityBreakdownChart', 'pie', 'priorite', 'count', [
        'rgba(255, 99, 132, 0.5)',
        'rgba(54, 162, 235, 0.5)',
        'rgba(255, 206, 86, 0.5)',
        'rgba(75, 192, 192, 0.5)'
    ], [
        'rgb(255, 99, 132)',
        'rgb(54, 162, 235)',
        'rgb(255, 206, 86)',
        'rgb(75, 192, 192)'
    ]);

    // Status Breakdown
    createChart('statusBreakdownChart', 'pie', 'statut', 'count', [
        'rgba(255, 99, 132, 0.5)',
        'rgba(54, 162, 235, 0.5)',
        'rgba(255, 206, 86, 0.5)',
        'rgba(75, 192, 192, 0.5)',
        'rgba(153, 102, 255, 0.5)'
    ], [
        'rgb(255, 99, 132)',
        'rgb(54, 162, 235)',
        'rgb(255, 206, 86)',
        'rgb(75, 192, 192)',
        'rgb(153, 102, 255)'
    ]);

    // Severity Distribution
    createChart('severityDistributionChart', 'bar', 'niveau_severite', 'count', 'rgba(255, 159, 64, 0.5)', 'rgb(255, 159, 64)');
</script>
{% endblock %}