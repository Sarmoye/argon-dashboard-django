{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- Header -->
    <div class="header bg-primary pb-6">
      <div class="container-fluid">
        <div class="header-body">
          <div class="row align-items-center py-4">
            <div class="col-lg-6 col-7">
              <h6 class="h2 text-white d-inline-block mb-0">Default</h6>
              <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                  <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                  <li class="breadcrumb-item"><a href="#">Dashboards</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Default</li>
                </ol>
              </nav>
            </div>
            <div class="col-lg-6 col-5 text-right">
              <a href="#" class="btn btn-sm btn-neutral">New</a>
              <a href="#" class="btn btn-sm btn-neutral">Filters</a>
            </div>
          </div>
          <!-- Card stats -->
          <div class="row">
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <!-- Card body -->
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Total Errors</h5>
                      <span class="h2 font-weight-bold mb-0">{{ total_erreurs_distinctes }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                        <i class="ni ni-collection"></i>
                      </div>
                    </div>
                  </div>
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-danger mr-2"><i class="fa fa-exclamation-circle"></i> Incident Tracking</span>
                    <span class="text-nowrap">All sources combined</span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <!-- Card body -->
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Open Errors</h5>
                      <span class="h2 font-weight-bold mb-0">{{ erreurs_ouvertes }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                        <i class="ni ni-support-16"></i>
                      </div>
                    </div>
                  </div>
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-danger mr-2"><i class="fa fa-exclamation-triangle"></i> Pending</span>
                    <span class="text-nowrap">To be processed</span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <!-- Card body -->
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Resolved Errors</h5>
                      <span class="h2 font-weight-bold mb-0">{{ erreurs_resolues }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                        <i class="ni ni-check-bold"></i>
                      </div>
                    </div>
                  </div>
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-success mr-2"><i class="fa fa-check-circle"></i> Resolved</span>
                    <span class="text-nowrap">Problem solved</span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <!-- Card body -->
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Average Resolution Time</h5>
                      <span class="h2 font-weight-bold mb-0">{{ moyenne_globale_resolution }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                        <i class="ni ni-time-alarm"></i>
                      </div>
                    </div>
                  </div>
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-warning mr-2"><i class="fa fa-clock"></i> Average resolution time</span>
                    <span class="text-nowrap">Based on all errors</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page content -->
    <div class="container-fluid mt--6">
      <div class="row">
        <div class="col-xl-8">
          <div class="card bg-default">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-light text-uppercase ls-1 mb-1">Overview</h6>
                  <h5 class="h3 text-white mb-0">Evolution of errors</h5>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- Chart -->
              <div class="chart">
                <canvas id="chart-sales-dark1" class="chart-canvas" data-dates='{{ dates|escapejs }}' data-counts='{{ counts|escapejs }}'></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-4">
          <div class="card">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-muted ls-1 mb-1">Performance</h6>
                  <h5 class="h3 mb-0">Erreurs ouvertes par syst√®me</h5>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas id="chart-bars" class="chart-canvas"
                  data-systems='[
                    {% for item in erreurs_ouvertes_per_system %}
                      {"name": "{{ item.system_name }}", "value": {{ item.distinct_errors }}}
                      {% if not forloop.last %},{% endif %}
                    {% endfor %}
                  ]'
                ></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xl-8">
          <div class="card">
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Distribution by priority</h3>
                </div>
                <div class="col text-right">
                  <a href="#!" class="btn btn-sm btn-primary">See all</a>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <!-- Projects table -->
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Priority</th>
                    <th scope="col">Error Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in erreurs_par_priorite %}
                  <tr>
                      <td>{{ item.priorite }}</td>
                      <td>{{ item.distinct_errors }}</td>
                  </tr>
                  {% endfor %}
              </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-xl-4">
          <div class="card">
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Distribution by severity</h3>
                </div>
                <div class="col text-right">
                  <a href="#!" class="btn btn-sm btn-primary">See all</a>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <!-- Projects table -->
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Severity</th>
                    <th scope="col">Error Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in erreurs_par_gravite %}
                  <tr>
                      <td>{{ item.gravite }}</td>
                      <td>{{ item.distinct_errors }}</td>
                  </tr>
                  {% endfor %}
              </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      {% include "includes/footer.html" %}

    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('chart-bars');
  const ctx = canvas.getContext('2d');
  
  // Get data from the data-systems attribute
  const systemsData = JSON.parse(canvas.dataset.systems || '[]');
  
  // Prepare data for the chart
  const labels = systemsData.map(item => item.name);
  const values = systemsData.map(item => item.value);
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Erreurs ouvertes',
        data: values,
        backgroundColor: 'rgba(94, 114, 228, 0.8)',
        borderColor: 'rgba(94, 114, 228, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            borderDash: [2],
            borderDashOffset: [2],
            drawBorder: false,
            drawTicks: false
          },
          ticks: {
            padding: 10
          }
        },
        x: {
          grid: {
            drawBorder: false,
            display: false,
            drawOnChartArea: false,
            drawTicks: false
          },
          ticks: {
            padding: 20,
            font: {
              size: 11
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: '#fff',
          titleColor: '#333',
          bodyColor: '#666',
          bodySpacing: 4,
          padding: 12,
          borderColor: '#e9ecef',
          borderWidth: 1,
          usePointStyle: true,
          mode: 'index',
          intersect: 0
        }
      }
    }
  });
});
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
    var canvas = document.getElementById("chart-sales-dark1");
    if (!canvas) {
        console.error("Canvas element not found!");
        return;
    }

    console.log("Raw data-dates:", canvas.getAttribute("data-dates"));
    console.log("Raw data-counts:", canvas.getAttribute("data-counts"));

    try {
        var dates = JSON.parse(canvas.getAttribute("data-dates") || "[]");
        var counts = JSON.parse(canvas.getAttribute("data-counts") || "[]");

        console.log("Parsed dates:", dates);
        console.log("Parsed counts:", counts);

        if (dates.length === 0 || counts.length === 0) {
            console.warn("Chart data is empty! Check your Django template.");
        }

        var ctx = canvas.getContext("2d");
        new Chart(ctx, {
            type: "line",
            data: {
                labels: dates,
                datasets: [{
                    label: "Errors Per Day",
                    data: counts,
                    borderColor: "rgba(75, 192, 192, 1)",
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: "Date" } },
                    y: { title: { display: true, text: "Number of Errors" }, beginAtZero: true }
                }
            }
        });
    } catch (error) {
        console.error("Error parsing chart data:", error);
    }
});
</script>
{% endblock javascripts %}
